@model ERPMVC.DTO.AlertDTO
@addTagHelper *, Kendo.Mvc

@{ Layout = null;
    var messages = new Dictionary<string, string>() { { "custom", "Ingrese un valor correcto." },
    {"required","Requerido" }
};
    // var rules = new Dictionary<string, string>() { { "custom", "customFunction" } };
}

<script>

    //function customFunction(input) {

    //    if (input.attr('name') === "BranchId" && input.val() === "0") {
    //        return false;
    //    }

    //}

    //$('#btnprueba').val("");
</script>

<div id="ModalAlert" class="modal fade" role="dialog">
    <!-- Modal content-->
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" name="btnprueba" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Alertas</h4>
            </div>
            <div class="modal-body">
                <div class="row" id="validation">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-body">
                                <form id="frmAlerts" kendo-validator="true" kendo-messages="messages"
                                      data-ajax="true"
                                      data-ajax-method="post"
                                      data-ajax-begin="SaveAlert"
                                      class="validation-wizard wizard-circle">
                                    <div class="form-body">
                                        <h3 class="card-title">Alertas</h3>
                                        <hr>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="AlertId" class=" control-label" style="width:100%"></label>
                                                    <input type="text" asp-for="AlertId" id="AlertId" class="form-control" readonly style="min-width:100%" />
                                                    <span asp-validation-for="AlertId" class="text-danger"></span>
                                                </div>
                                            </div>

                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="Code" class=" control-label" style="min-width:100%">Código</label>
                                                    <input type="text" asp-for="Code" name="Code" id="Code" class="form-control" autocomplete="off" style="min-width:100%" maxlength="100" readonly />
                                                    <span asp-validation-for="Code" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="CloseDate" class=" control-label" style="min-width:100%">Fecha de Cierre</label>
                                                    <input type="text" asp-for="CloseDate" name="CloseDate" id="CloseDate" class="form-control" autocomplete="off" style="min-width:100%" maxlength="100" readonly />
                                                    <span asp-validation-for="CloseDate" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="Type" class=" control-label" style="min-width:100%">Tipo</label>
                                                    <input type="text" asp-for="Type" name="Type" id="Type" class="form-control" autocomplete="off" style="min-width:100%" maxlength="100" readonly />
                                                    <span asp-validation-for="Type" class="text-danger"></span>
                                                </div>
                                            </div>




                                        </div>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="AlertName" class=" control-label" style="min-width:100%">Alerta</label>
                                                    <input type="text" asp-for="AlertName" name="AlertName" class="form-control" autocomplete="off" style="min-width:100%" maxlength="50" readonly />
                                                    <span asp-validation-for="AlertName" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="DocumentName" class=" control-label" style="min-width:100%">Origen</label>
                                                    <input type="text" asp-for="DocumentName" name="DocumentName" id="DocumentName" class="form-control" autocomplete="off" style="min-width:100%" maxlength="100" readonly />
                                                    <span asp-validation-for="DocumentName" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="Description" class=" control-label" style="min-width:100%">Descripcion</label>
                                                    <input type="text" asp-for="Description" name="Description" id="Description" class="form-control" autocomplete="off" style="min-width:100%" maxlength="100" readonly />
                                                    <span asp-validation-for="Description" class="text-danger"></span>
                                                </div>
                                            </div>


                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="AlertType" class=" control-label" style="min-width:100%">Persona/Producto</label>
                                                    <input type="text" asp-for="AlertType" name="AlertType" id="AlertType" class="form-control" autocomplete="off" style="min-width:100%" maxlength="100" readonly />
                                                    <span asp-validation-for="AlertType" class="text-danger"></span>
                                                </div>
                                            </div>

                                        </div>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="SujetaARos" class=" control-label" style="min-width:100%">Sujeta a Reporte ROS</label>
                                                    @(Html.Kendo().SwitchFor(m => m.SujetaARos)

                                                                                           .Name("SujetaARos").Messages(m => m.Checked("Si"))//.Readonly(true)
                                                                                                                                             //.Events(ev => ev.Change("onChange"))

                                                    )
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="FalsoPositivo" class=" control-label" style="min-width:100%">Falso Positivo</label>
                                                    @(Html.Kendo().SwitchFor(m => m.FalsoPositivo)

                                                                                           .Name("FalsoPositivo").Messages(m => m.Checked("Si"))
                                                            //.Events(ev => ev.Change("onChange"))

                                                    )
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="Estado" class=" control-label" style="min-width:100%">Estado</label>
                                                    @(Html.Kendo().DropDownList()
                                                                                        .Name("Estado")
                                                                                        .DataTextField("Text")
                                                                                        .DataValueField("Value")
                                                                                        //.Events(e => e.Change("change"))
                                                                                        .BindTo(new List<SelectListItem>() {
                                                                                                                                                                                                                                                new SelectListItem() {
                                                                                                                                                                                                                                                    Text = "En Proceso de Analisis",
                                                                                                                                                                                                                                                    Value = "En Proceso de Analisis"
                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                new SelectListItem() {
                                                                                                                                                                                                                                                    Text = "Cerrada",
                                                                                                                                                                                                                                                    Value = "Cerrada"
                                                                                                                                                                                                                                                }
                                                                                        })
                                                                                        .Value("1")
                                                                                        .HtmlAttributes(new { style = "width: 100%" })
                                                    )
                                                    <span asp-validation-for="Estado" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="ActionTakenName" class=" control-label" style="min-width:100%">Acción Tomada</label>
                                                    @(Html.Kendo().DropDownList()
                                                                                        .Name("ActionTakenName")
                                                                                        .DataTextField("Text")
                                                                                        .DataValueField("Value")
                                                                                        //.Events(e => e.Change("change"))
                                                                                        .BindTo(new List<SelectListItem>() {
                                                                                                                                                                                                                                                new SelectListItem() {
                                                                                                                                                                                                                                                    Text = "Analizada",
                                                                                                                                                                                                                                                    Value = "Analizada"
                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                new SelectListItem() {
                                                                                                                                                                                                                                                    Text = "Pendiente de Analisis ",
                                                                                                                                                                                                                                                    Value = "Pendiente de Analisis "
                                                                                                                                                                                                                                                }
                                                                                        })
                                                                                        .Value("1")
                                                                                        .HtmlAttributes(new { style = "width: 100%" })
                                                    )
                                                    <span asp-validation-for="ActionTakenName" class="text-danger"></span>
                                                </div>
                                            </div>


                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label asp-for="Observacion">Observacion</label>
                                                    <textarea required rows="4" maxlength="500" asp-for="Observacion" class="form-control" name="Observacion" id="Observacion" style="min-width:100%"></textarea>
                                                    <span asp-validation-for="Observacion" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>


                                        <div class="row">
                                            <div class="col-md-12">
                                                <button id="btnGuardar" class="form-control btn-miboton" type="submit"> Guardar </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    var cerrada = false;

    $(document).ready(function () {
        debugger;
        var fechaCierre = $('#CloseDate').val();
        //var estado = $('#Estado').val();
        if (fechaCierre != '1/1/0001 12:00:00 AM' && fechaCierre != '01/01/0001 0:00:00' && fechaCierre != null) {
       // if (estado == 'Cerrado') {
            $('#FalsoPositivo').attr('readonly', true);
            $('#SujetaARos').attr('readonly', true);
            $('#AlertType').attr('readonly', true);
            $('#Observacion').attr('readonly', true);
            $('#ActionTakenName').attr('readonly', true);
            cerrada = true;
        }


    });


    function SaveAlert(e) {

        if (cerrada) {
            $.toast({
                heading: 'Error ',
                text: ' Alerta Cerrada no puede ser modificada',
                position: 'top-right',
                loaderBg: '#ff6849',
                icon: 'error',
                hideAfter: 3000,
                stack: 6
            });
            return;
        }

            var notification = $("#notification").data("kendoNotification");
           // e.preventDefault();
                 $("#btnGuardar").hide();
                $("#btnGuardar").prop("disabled", true);

           // var displayedData = $("#gridCountry").data().kendoGrid.dataSource.view();

        var dataObject = {
            'AlertId': $("#AlertId").val() === "" ? "0" : $("#AlertId").val(),
            'Code' : $('#Code').val(),
            'CloseDate' : $('#CloseDate').val(),
            'Estado' : $('#Estado').val(),
            'AlertName' : $('#AlertName').val(),
            'DocumentName' : $('#DocumentName').val(),
            'Description' : $('#Description').val(),
            'ActionTakenName' : $('#ActionTakenName').val(),
            'FalsoPositivo' : $('#FalsoPositivo').is(':checked'),
            'SujetaARos': $('#FalsoPositivo').is(':checked'),
            'Type' : $('#Type').val(),
            'AlertType': $('#AlertType').val(),
            'Observacion' :  $('#Observacion').val(),
                           
            };

           // console.log(JSON.stringify(dataObject));
            //var form = $("#frmNumeracion");
           // form.validate();

            var validator = $("#frmAlerts").data("kendoValidator");
                 var status = $(".status");

                if (validator.validate()) {

                    $.ajax({
                        url: '@Url.Action("SaveAlert", "Alert")',
                        method: 'POST',
                        datatype: "json",
                        contentType: 'application/json',
                        async: false,
                        data: JSON.stringify(dataObject),
                        success: function (data) {

                            //notification.show({
                            //    message: "Guardado correctamente!"
                            //}, "upload-success");
                            $.toast({
                                heading: 'Satisfactorio',
                                text: 'Datos guardados correctamente.',
                                position: 'top-right',
                                loaderBg: '#ff6849',
                                icon: 'success',
                                hideAfter: 30000,
                                stack: 6
                            });

                            RefrescarGrid();

                            $('#ModalAlert').modal('hide');





                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {

                            notification.show({
                                title: "Validación",
                                message: textStatus + ": " + XMLHttpRequest.responseText
                            }, "error");

                        }
                    });

                }
                else {
                    notification.show({
                        title: "Validación",
                        message: "Datos no validos en el formulario"
                    }, "error");
                }


            $("#btnGuardar").show();
            $("#btnGuardar").prop("disabled", false);
    }
</script>
