@model ERPMVC.DTO.InvoiceDTO
@using System.Security.Claims
@{
    ClaimsPrincipal permisos = (ClaimsPrincipal)ViewData["permisosInvoice"];
}

<script>

    function CalcularTotalDocumento() {
        
    }

    function setearvalor(nombrenumerico, valor) {
        var numeric = $("#" + nombrenumerico).data("kendoNumericTextBox");
        numeric.value(valor);
        numeric.trigger('change');
        numeric = null;
    }


    function GetInvoiceId() {
            var ProductId = $("#ProductId").val();
            var ContractId = $("#CustomerContractId").val();
            var CustomerId = $("#CustomerId").val();
            var InvoiceId = $("#InvoiceId").val();

            return {
                ProductId: ProductId,
                CustomerId: CustomerId,
                ContractId: ContractId,
                InvoiceId : InvoiceId
            };
    }

    function RefreshInvoiceDetail() {
        var grid = $("#gridInvoiceDetail").getKendoGrid();
        grid.dataSource.read();
    }


    

</script>



@(
Html.Kendo().Grid<ERPMVC.Models.InvoiceLine>()
                                                                  .Name("gridInvoiceDetail")
                                                                  .Columns(columns =>
                                                                  {

                                                                  columns.Command(command =>
                                                      {

                                                                          if (Model.CAI == null || Model.CAI == String.Empty)
                                                                          {
                                                                              command.Destroy().Text(" ").IconClass("far fa-trash-alt");
                                                                          }
                                                                      }).Title("").Width(80);

                                                                      columns.Bound(p => p.InvoiceLineId).Title("No").Width(80).Visible(false);
                                                                      columns.Bound(p => p.InvoiceId).Title("Factura Id").Width(200).Visible(false);
                                                                      columns.Bound(p => p.SubProductId).Title("IdProducto").Visible(false);
                                                                      columns.Bound(p => p.SubProductName).Title("Producto").Width(250).Visible(false);
                                                                      columns.Bound(p => p.SubProduct).Title("Producto")
                                                                      .ClientTemplate("#=typeof SubProduct === 'undefined'||SubProduct===null?SubProductName:SubProduct.ProductName#").Width(250);
                                                                      columns.Bound(p => p.UnitOfMeasure).Title("Unidad Medida")
                                                                      .ClientTemplate("#=typeof UnitOfMeasure === 'undefined'||UnitOfMeasure===null?UnitOfMeasureName:UnitOfMeasure.UnitOfMeasureName#").Width(250);

                                                                      columns.Bound(p => p.Description).Title("Descripción").Width(250).Visible(false);
                                                                      columns.Bound(p => p.Quantity).Format("{0:n2}").Title("Cantidad").Width(150);
                                                                      columns.Bound(p => p.Price).Format("{0:n2}").Title("Precio").Format("{0:n2}").Width(150);
                                                                      columns.Bound(p => p.UnitOfMeasureId).Title("Unidad de medida").Visible(false);
                                                                      columns.Bound(p => p.Amount).Title("SubTotal").Format("{0:n2}").Width(180);
                                                                      columns.Bound(p => p.DiscountAmount).Format("{0:n2}").Title("Descuentos").Width(200);
                                                                      columns.Bound(p => p.SubTotal).Format("{0:n2}").Title("Sub Total").Width(200).Visible(false);
                                                                      columns.Bound(p => p.TaxCode).Title("Tipo Impuesto").Width(250).Visible(false);
                                                                      columns.Bound(p => p.TaxAmount).Format("{0:n2}").Title("Impuestos").Width(150);
                                                                      columns.Bound(p => p.Total).Format("{0:n2}").Title("Total").Width(180);

                                                                  })
                                                                      .Filterable(f => f.Operators(o => o.ForString(s => s
                                                               .Clear()
                                                               .Contains("Contiene")
                                                               .DoesNotContain("No contiene")
                                                               .EndsWith("Termina con")
                                                               .IsEqualTo("Es igual a")
                                                               .IsNotEqualTo("No es igual a")
                                                               .IsNull("Es nulo")
                                                               .StartsWith("Inicia con")


                                                         )
                                                         .ForNumber(n => n
                                                           .Clear()
                                                           .IsEqualTo("Es igual a")
                                                           .IsGreaterThan("Es mayor que")
                                                           .IsLessThan("Es menor que")
                                                           .IsNull("Es nulo")
                                                           .IsLessThanOrEqualTo("Es menor o igual que")
                                                           .IsGreaterThanOrEqualTo("Es mayor o igual que")
                                                         )
                                                         .ForDate(d => d
                                                         .Clear()
                                                         .IsEqualTo("Es igual que")
                                                         .IsGreaterThan("Es mayor que")
                                                         .IsLessThan("Es menor que")
                                                         .IsLessThanOrEqualTo("Es menor o igual que")
                                                         .IsGreaterThanOrEqualTo("Es mayor o igual que")
                                                         .IsNotEqualTo("No es igual que")
                                                          )
                                                       ))
                                                                  .ToolBar(tools =>
                                                                  {
                                                                      if (Model.InvoiceId == 0)
                                                                      {
                                                                          tools.Create().Text("Agregar").IconClass("k-icon k-i-plus")
                                                                          .HtmlAttributes(new { @class = "k-i-plus-sm" });
                                                                      }


                                                                  })
                                                                   .Editable(e => e.Mode(GridEditMode.InCell))
                                                                    .Sortable()
                                                                    .AutoBind(true)
                                                                    .Filterable()
                                                                    .Scrollable()
                                                                    .Events(e => e.DataBound("CalcularTotalDocumento"))
                                                                    .DataSource(dataSource =>

                                                                   dataSource
                                                                   //.Ajax()
                                                                   .WebApi()

                                                                    .ServerOperation(true)
                                                                    .Model(model =>
                                                                    {
                                                                        model.Id(p => p.InvoiceLineId);
                                                                        model.Field(p => p.InvoiceLineId).Editable(false);
                                                                        model.Field(p => p.InvoiceId).Editable(false);

                                                                    })
                                                                    .Events(events =>
                                                                    {
                                                                        events.Error("error_handler");

                                                                    })
                                                                    .Sort(s => s.Add(m => m.InvoiceLineId).Descending())
                                                                    .Read(read => read.Action("GetInvoiceLineByInvoiceId", "InvoiceLine").Data("GetInvoiceId"))
                                                              )
        )


<script>

    function setToolbarTooltip(btn_cl, btn_tooltip) {
        $("#gridInvoiceDetail").kendoTooltip({
            filter: btn_cl,
            content: btn_tooltip
        });
    }

    function setRowButtonTooltip(btn_cl, btn_tooltip) {
        $("#gridInvoiceDetail").kendoTooltip({
            filter: btn_cl,
            content: btn_tooltip
        });
    }

    //setRowButtonTooltip(".k-grid-GenerarFactura", "Generar una factura fiscal!");
    setRowButtonTooltip(".k-grid-Eliminar", "Eliminar registro");
     if (@Model.InvoiceId> 0) {
        setRowButtonTooltip(".k-grid-Editar", "Ver Detalle");
    }
    else {
        setRowButtonTooltip(".k-grid-Editar", "Editar registro");
    }
    setRowButtonTooltip(".k-grid-Agregar", "Agregar nuevo registro");
</script>