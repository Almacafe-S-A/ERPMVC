@model ERPMVC.DTO.GoodsDeliveredDTO
@using System.Security.Claims

@{ Layout = null;
    var messages = new Dictionary<string, string>() { { "custom", "Ingrese un valor correcto." },
                                {"required","Valor requerido" }
                            };
    var rules = new Dictionary<string, string>() { { "custom", "customFunction" } };
    ClaimsPrincipal permisos = (ClaimsPrincipal)ViewData["permisos"];
}

<div id="myModalGoodsDelivered" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Información Entrega de Mercadería</h4>
                <button type="button" class="close" onclick="closeGoodsDelivered();">&times;</button>
            </div>
            <div class="modal-body">


                <div class="row" id="validation">
                    <div class="col-lg-12">
                        <div class="card">


                            <div class="card-body">
                                <form id="frmGoodsDelivered" kendo-validator="true" kendo-messages="messages" kendo-rules="rules"
                                      method="post" class="validation-wizard wizard-circle">
                                    <div class="form-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="GoodsDeliveredId" class="control-label" style="width:100%"></label>
                                                    <kendo-numerictextbox name="SalesOrderId"
                                                                          format="n"
                                                                          min="0"
                                                                          readonly
                                                                          max="99999999"
                                                                          step="1"
                                                                          spinners="false"
                                                                          style="width: 100%;"
                                                                          value="Model.GoodsDeliveredId" />
                                                    <span asp-validation-for="GoodsDeliveredId" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="DocumentDate" class=" control-label" style="width: 100%;"></label>
                                                    <kendo-datetimepicker name="DocumentDate"
                                                                          style="width: 100%;"
                                                                          format="dd/MM/yyyy hh:mm:ss"
                                                                          time-format="hh:mm:ss"
                                                                          data-val-required="La fecha es requerida"
                                                                          value="Model.DocumentDate" />
                                                    <span asp-validation-for="DocumentDate" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="ExpirationDate" class=" control-label" style="width: 100%;"></label>
                                                    <kendo-datetimepicker name="v"
                                                                          style="width: 100%;"
                                                                          format="dd/MM/yyyy hh:mm:ss"
                                                                          time-format="hh:mm:ss"
                                                                          data-val-required="La fecha es requerida"
                                                                          value="Model.ExpirationDate" />
                                                    <span asp-validation-for="ExpirationDate" class="text-danger"></span>
                                                </div>
                                            </div>



                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label asp-for="ExitTicket" class="control-label" style="width:100%"></label>
                                                    <kendo-numerictextbox name="ExitTicket"
                                                                          format="n"
                                                                          min="0"
                                                                          enable="false"
                                                                          max="99999999"
                                                                          spinners="false"
                                                                          step="1"
                                                                          style="width: 100%;"
                                                                          value="Model.ExitTicket" />
                                                    <span asp-validation-for="ExitTicket" class="text-danger"></span>
                                                </div>

                                            </div>



                                        </div>

                                    </div>

                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <script>
                                                    function FillWareHouse(e) {
                                                        //var WarehouseId = $("#WarehouseId").getkendoDropDownList();
                                                        //WarehouseId.dataSource.read();
                                                        var dataItem = e.dataItem;
                                                        $("#warehousesetid").val(dataItem.BranchId);
                                                        $("#WarehouseId").data("kendoDropDownList").dataSource.read();
                                                        //$("#SubProductId").data("kendoDropDownList").dataSource.read();
                                                    }


                                                </script>
                                                @*on-select="FillWareHouse"*@
                                                <input type="hidden" id="warehousesetid" />
                                                <label asp-for="BranchId" class="control-label"></label>
                                                <kendo-dropdownlist name="BranchId" for="BranchId" filter="Kendo.Mvc.UI.FilterType.Contains"
                                                                    option-label="Seleccione Sucursal"
                                                                    datatextfield="BranchName"
                                                                    datavaluefield="BranchId"
                                                                    required
                                                                    auto-bind="true"
                                                                    style="width: 100%;">
                                                    <datasource type="DataSourceTagHelperType.WebApi" page-size="99999999">
                                                        <transport>
                                                            <read url="@Url.Action("GetBranch", "Branch")" />
                                                        </transport>
                                                    </datasource>
                                                </kendo-dropdownlist>
                                                <span asp-validation-for="BranchId" class="text-danger"></span>
                                            </div>
                                        </div>

                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <script>

                                                    function GetSubProduct(e) {
                                                        $("#ControlId").data("kendoDropDownList").dataSource.read();

                                                    }

                                                </script>


                                                <label asp-for="CustomerId" class="control-label">Cliente</label>
                                                <kendo-dropdownlist name="CustomerId" for="CustomerId" filter="Kendo.Mvc.UI.FilterType.Contains"
                                                                    option-label="Seleccione el cliente"
                                                                    required data-required-msg="Cliente es requerido"
                                                                    datatextfield="CustomerName"
                                                                    datavaluefield="CustomerId"
                                                                    on-change="GetSubProduct"
                                                                    style="min-width: 100%;">
                                                    <datasource type="DataSourceTagHelperType.WebApi" page-size="9999999">
                                                        <transport>
                                                            <read url="@Url.Action("GetCustomer", "Common")" />
                                                        </transport>
                                                    </datasource>
                                                </kendo-dropdownlist>
                                            </div>
                                        </div>


                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <script>
                                                </script>
                                                <label asp-for="ProductId" class="control-label" style="width:100%">Servicio</label>
                                                <kendo-dropdownlist name="ProductId" filter="Kendo.Mvc.UI.FilterType.Contains"
                                                                    for="ProductId"
                                                                    option-label="Seleccione el Servicio"
                                                                    datatextfield="ProductName"
                                                                    datavaluefield="ProductId"
                                                                    required data-required-msg="Servicio es requerido"
                                                                    style="width: 100%;">
                                                    <datasource type="DataSourceTagHelperType.WebApi" page-size="999999999">
                                                        <transport>
                                                            <read url="@Url.Action("GetProduct", "Common")" />
                                                        </transport>
                                                    </datasource>
                                                </kendo-dropdownlist>
                                                <span asp-validation-for="ProductId" class="text-danger"></span>
                                            </div>
                                        </div>

                                        <div class="col-md-3">
                                            <div class="form-group">                                           
                                                    <label asp-for="ControlId" class="control-label" style="width:100%">Asociar Control de Salida</label>
                                                    <kendo-dropdownlist name="ControlId" filter="Kendo.Mvc.UI.FilterType.Contains"
                                                                        for="ControlId"
                                                                        option-label="Seleccione el Servicio"
                                                                        datatextfield="CustomerName"
                                                                        datavaluefield="ControlPalletsId"
                                                                        required data-required-msg="Servicio es requerido"
                                                                        style="width: 100%;">
                                                        <datasource type="DataSourceTagHelperType.WebApi" page-size="999999999">
                                                            <transport>
                                                                <read url="@Url.Action("GetSalidasByCustomer", "ControlPallets")" data="GetCustomerControl" />
                                                            </transport>
                                                        </datasource>
                                                    </kendo-dropdownlist>

                                                



                                            </div>

                                        </div>
                                    </div>


                                    <div class="row">

                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="cbxBuscar" class="control-label" style="width:100%">Autorizacion de Retiro</label>                                                
                                                <input type="hidden" id="singuardar" value="0" />
                                                @(Html.Kendo().DropDownList()
                                                              .Name("cbxBuscar")
                                                              .Filter(Kendo.Mvc.UI.FilterType.Contains)
                                                              .OptionLabel("Buscar")
                                                              .DataTextField("CustomerName")
                                                              .DataValueField("GoodsDeliveryAuthorizationId")
                                                              .HtmlAttributes(new { style = "width:100%" })
                                                              .Height(290)
                                                              .Events(e =>
                                                              {
                                                                  //e.Change("changesetearvalues");
                                                                                                  })
                                                              .AutoBind(true)
                                                              .DataSource(source =>
                                                              {
                                                                  source.Ajax()
                                                                  .PageSize(80)

                                                                  .Read("Virtualization_Read", "GoodsDeliveryAuthorization");
                                                              })
                                                    )


                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label asp-for="Reference" class="control-label" style="width: 100%;"></label>
                                                <input type="text" id="Reference" required class="k-textbox" style="min-width: 100%;" asp-for="Reference" />
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label asp-for="Name" class="control-label" style="width: 100%;"></label>
                                                <input type="text" id="test" required class="k-textbox" style="min-width:100%;" asp-for="Name" />
                                            </div>
                                        </div>
                                    </div>


                                    <div class="row">


                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label asp-for="Placa" class="control-label" style="width: 100%;"></label>
                                                <input type="text" id="Placa" required class="k-textbox" style="min-width:100%;" asp-for="Placa" />
                                            </div>
                                        </div>

                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label asp-for="Marca" class="control-label" style="width: 100%;"></label>
                                                <input type="text" id="Marca" required class="k-textbox" style="min-width: 100%;" asp-for="Marca" />
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label asp-for="Comments" class="control-label" style="width: 100%;"></label>
                                                <textarea id="Comments" required class="k-textarea" style="min-width: 100%;" asp-for="Comments">@Model.Comments</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </form>


                                <div id="salesorderdetail">
                                    @await Html.PartialAsync("pvwGoodsDeliveredDetail", Model, new ViewDataDictionary(ViewData) { { "permisosGoodsDelivered", permisos } })
                                </div>

                                <div class="row">
                                    @if (Model.GoodsDeliveredId == 0)
                                    {
                                        <button id="btnSaveControlEstiba" type="submit" class="form-control btn-miboton" onclick="SaveGoodsDelivered(this);">Guardar</button>
                                    }
                                </div>


                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>



<script>


    function customFunction(input) {

        if (input.attr('name') === "BranchId" && input.val() === "0") {
            return false;
        }

        if (input.attr('name') === "CurrencyId" && input.val() === "0") {
            return false;
        }

        if (input.attr('name') === "ControlPalletsId" && input.val() === "0") {
            return false;
        }

        if (input.attr('name') === "Quantity" && input.val() == 0) {
            return false;
        }

        if (input.attr('name') === "Price" && input.val() == 0) {
            return false;
        }

        if (input.attr('name') === "TotalLine" && input.val() == 0) {
            return false;
        }

       



        return true;
    }

    function closeGoodsDelivered() {
        $("#myModalGoodsDelivered").modal('hide');
        var grid = $("#gridGoodsDelivered").getKendoGrid();
        grid.dataSource.read();
    }



                                                  
                                                           

                                                            function GetCustomerControl() {
                                                                return { CustomerId: $("#CustomerId").val() , esIngreso : 0}
                                                            }

                                                            function onbound() {
                                                                kendo.ui.progress($("#myModalControlPallets"), false);
                                                            }
</script>


<script>


    function RefreshGridGoodsDelivered() {
        var grid = $("#gridGoodsDelivered").getKendoGrid();
        grid.dataSource.read();
    }

    function SaveGoodsDelivered(e) {

        var notification = $("#notification").data("kendoNotification");

        if ($("#cbxBuscar").val() !== '' && $("#cbxBuscar").val() !== null) {
            // e.preventDefault();
            $("#btnSaveControlEstiba").hide();
            $("#btnSaveControlEstiba").prop("disabled", true);

            var validadetalle = true;
            var displayedData = $("#gridGoodsDeliveredDetail").data().kendoGrid.dataSource.data();
            for (var i = 0; i < displayedData.length; i++) {
                displayedData[i].GoodsDeliveredLinedId = 0;
                if (
                    displayedData[i].WareHouseId === '' || displayedData[i].Quantity === 0
                    || displayedData[i].WareHouseId === null || displayedData[i].WareHouseId === 0) {
                    notification.show({
                        title: "Validación",
                        message: "Ingrese al detalle todos los datos requeridos"
                    }, "error");
                    validadetalle = false;

                }
            }
            if (validadetalle) {
                var dataObject = {
                    'GoodsDeliveredId': $("#GoodsDeliveredId").val(),
                    'CustomerId': $("#CustomerId").val(),
                    'CustomerName': $("#CustomerId").data("kendoDropDownList").text(),
                    'BranchId': $("#BranchId").val(),
                    'BranchName': $("#BranchId").data("kendoDropDownList").text(),
                    'Placa': $("#Placa").val(),
                    'Marca': $("#Marca").val(),
                    'ProductId': $("#ProductId").val(),
                    'ProductName': $("#ProductId").data("kendoDropDownList").text(),
                    'OrderDate': $("#DocumentDate").getKendoDateTimePicker().value().toJSON(),
                    'DocumentDate': $("#DocumentDate").getKendoDateTimePicker().value().toJSON(),
                    'Name': $("#Name").val(),
                    'Reference': $("#Reference").val(),
                    'ExitTicket': $("#ExitTicket").val(),
                    'Comments': $("#Comments").val(),
                    'GoodsDeliveryAuthorizationId': ($("#cbxBuscar").val()),
                    'WeightBallot': $("#WeightBallot").val(),
                    '_GoodsDeliveredLine': displayedData

                };

                var validator = $("#frmGoodsDelivered").data("kendoValidator");
                var validator2 = $("#TotalesDocumento").data("kendoValidator");
                var status = $(".status");

                if (displayedData.length > 0) {
                    if (validator.validate() && validator2.validate()) {

                        $.ajax({
                            url: '@Url.Action("SaveGoodsDelivered", "GoodsDelivered")',
                            method: 'POST',
                            datatype: "json",
                            //contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                            contentType: 'application/json',
                            async: false,
                            data: JSON.stringify(dataObject),
                            success: function (data) {

                                $.toast({
                                    heading: 'Satisfactorio',
                                    text: 'Datos guardados correctamente.',
                                    position: 'top-right',
                                    loaderBg: '#ff6849',
                                    icon: 'success',
                                    hideAfter: 7000,
                                    stack: 6
                                });

                                //notification.show({
                                //    message: "Guardado correctamente!"
                                //}, "upload-success");

                                RefreshGridGoodsDelivered();
                                $('#myModalGoodsDelivered').modal('hide');

                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                $("#btnSaveControlEstiba").show();
                                $("#btnSaveControlEstiba").prop("disabled", false);
                                $("#btngenerarfactura").show();
                                notification.show({
                                    title: "Validación",
                                    message: textStatus + ": " + XMLHttpRequest.responseText
                                }, "error");

                            }
                        });

                    }
                    else {
                        $("#btnSaveControlEstiba").show();
                        $("#btnSaveControlEstiba").prop("disabled", false);
                        //status.text("Oops! There is invalid data in the form.")
                        //    .removeClass("valid")
                        //    .addClass("invalid");
                    }
                }
                else {
                    $("#btnSaveControlEstiba").show();
                    $("#btnSaveControlEstiba").prop("disabled", false);
                    notification.show({
                        title: "Validación",
                        message: "Debe agregar los productos!"
                    }, "error");

                }
            }
            else {
                notification.show({
                    title: "Validación",
                    message: "Debe de seleccionar la autorización!"
                }, "error");
            }
        }
        else {
            $("#btnSaveControlEstiba").show();
            $("#btnSaveControlEstiba").prop("disabled", false);
        }

      //  $("#btnSaveControlEstiba").show();

    }
</script>