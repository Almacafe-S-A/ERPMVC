@model ERPMVC.DTO.SalesOrderDTO

@{ Layout = null;
    var messages = new Dictionary<string, string>() { { "custom", "Please choose another Start Time." } };
    var rules = new Dictionary<string, string>() { { "custom", "customFunction" } };
}

<script>
      function customFunction(input) {

        if (input.attr('name') === "time" && input.val() == "14:00") {
            return false;
        }

        return true;
    }
</script>

<div id="myModalSalesOrder" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Información Cotización</h4>
      </div>
      <div class="modal-body">
<div class="row" id="validation">
    <div class="col-lg-12">
        <div class="card">
        

            <div class="card-body">
                <form id="frmSalesOrder" kendo-validator="true" kendo-messages="messages" kendo-rules="rules"
                 method="post" class="validation-wizard wizard-circle">
                    <div class="form-body">
                        @*<h3 class="card-title">Información SalesOrder</h3>*@
                        <hr>
	    		    		
                        <div class="row">
                       <div class="col-md-4">
                         <div class="form-group">							     
				              <label asp-for="SalesOrderId" class="col-md-2 control-label" style="width:100%"></label>							            
							  <kendo-numerictextbox name="SalesOrderId"
                                  format="n"
                                  min="0"
                                    disabled
                                  max="99999999"
                                  step="1"
                                   style="width: 100%;"
                                  value="Model.SalesOrderId">
						     </kendo-numerictextbox>                      							 
							  <span asp-validation-for="SalesOrderId" class="text-danger"></span>		
			              </div>

	   			        </div>

                     <div class="col-md-4">
                         <div class="form-group">							     
				              <label asp-for="SalesOrderName" class="col-md-2 control-label"  style="width:100%"></label>
                               <input asp-for="SalesOrderName" class="form-control" style="width:100%" />
							  @*<textarea asp-for="SalesOrderName" class="form-control required " style="width: 100%;"></textarea>*@							  						
							  <span asp-validation-for="SalesOrderName" class="text-danger"></span>		
			              </div>
	   			        </div>
                               <div class="col-md-4">
                         <div class="form-group">							     
				              <label asp-for="BranchId" class="col-md-2 control-label"></label>							            
							  @*<kendo-numerictextbox name="BranchId"
                                  format="n"
                                  min="0"
                                    style="width: 100%;"
                                  max="99999999"
                                  step="1"
                                  value="Model.BranchId">
						     </kendo-numerictextbox>*@
                              <kendo-combobox name="BranchId" for="BranchId" filter="FilterType.Contains"
						    	placeholder="Select BranchId"
								datatextfield="BranchName"
								datavaluefield="BranchId"
								style="width: 100%;">
								<datasource type="DataSourceTagHelperType.WebApi">
									<transport>
										<read url="@Url.Action("Get", "Branch")" />
									</transport>
								</datasource>
							 </kendo-combobox>							 
							  <span asp-validation-for="BranchId" class="text-danger"></span>		
			              </div>
	   			        </div>
					 </div>		
                        

                    <div class="row">

                    </div>

                   
					 
					<div class="row">				                			
                       <div class="col-md-4">
                         <div class="form-group">							     
				              <label asp-for="CustomerId" class="col-md-2 control-label"></label>							            
						
                              <kendo-combobox name="CustomerId" for="@Model.CustomerId" filter="FilterType.Contains"
						    	placeholder="Select CustomerId"
								datatextfield="CustomerName"
								datavaluefield="CustomerId"
                                required
								style="width: 100%;">
								<datasource type="DataSourceTagHelperType.WebApi" server-operation="true"  >
									<transport>
										<read url="@Url.Action("GetCustomer", "Common")" />
									</transport>
								</datasource>
							 </kendo-combobox>							 
							  <span asp-validation-for="CustomerId" class="text-danger"></span>		
			              </div>
	   			        </div>
                       
                       <div class="col-md-4">
                         <div class="form-group">							     
				              <label asp-for="CurrencyId" class="col-md-2 control-label"></label>						            
                              <kendo-combobox name="CurrencyId" for="CurrencyId" filter="FilterType.Contains"
						    	placeholder="Select CurrencyId"
								datatextfield="CurrencyName"
								datavaluefield="CurrencyId"
								style="width: 100%;">
								<datasource type="DataSourceTagHelperType.WebApi">
									<transport>
										<read url="@Url.Action("GetCurrency", "Currency")" />
									</transport>
								</datasource>
							 </kendo-combobox>							 
							  <span asp-validation-for="CurrencyId" class="text-danger"></span>		
			              </div>
	   			        </div>
					
					  					
                       <div class="col-md-4">
                         <div class="form-group">							     
				              <label asp-for="CustomerRefNumber" class="col-md-2 control-label" style="width:100%"></label>
                              <input asp-for="CustomerRefNumber" class="form-control" style="width:100%" />
							  @*<textarea asp-for="CustomerRefNumber" class="form-control required " style="width: 100%;"></textarea>*@							  						
							  <span asp-validation-for="CustomerRefNumber" class="text-danger"></span>		
			              </div>
	   			        </div>
					 </div>		  					
                
					 				
					<div class="row">
                               <div class="col-md-4">
                         <div class="form-group">							     
				              <label asp-for="OrderDate" class="col-md-2 control-label" style="width: 100%;"></label>							            
							  <kendo-datetimepicker name="OrderDate"
							    style="width: 100%;"
                               data-val-required="La fecha es requerida"
								 value="Model.OrderDate">
							 </kendo-datetimepicker>						
							  <span asp-validation-for="OrderDate"  class="text-danger" ></span>		
			              </div>
	   			       </div>
					 				 		
                       <div class="col-md-4">
                         <div class="form-group">							     
				              <label asp-for="DeliveryDate" class="col-md-2 control-label" style="width: 100%;"></label>							            
							  <kendo-datetimepicker name="DeliveryDate"
							    style="width: 100%;"
								value="Model.DeliveryDate">
							 </kendo-datetimepicker>						
							  <span asp-validation-for="DeliveryDate" class="text-danger"></span>		
			              </div>
	   			       </div>
                       <div class="col-md-4">
                         <div class="form-group">							     
				              <label asp-for="SalesTypeId" class="col-md-2 control-label"  style="width:100%"></label>							            
							  @*<kendo-numerictextbox name="SalesTypeId"
                                  format="n"
                                    style="width: 100%;"
                                  min="0"
                                  max="99999999"
                                  step="1"
                                  value="Model.SalesTypeId">
						     </kendo-numerictextbox>*@
                              <kendo-combobox name="SalesTypeId" filter="FilterType.Contains"
						         for="SalesTypeId"
                            	placeholder="Select SalesTypeId"
								datatextfield="SalesTypeName"
								datavaluefield="SalesTypeId"
								style="width: 100%;">
								<datasource type="DataSourceTagHelperType.WebApi">
									<transport>
										<read url="@Url.Action("Get", "SalesType")" />
									</transport>
								</datasource>
							 </kendo-combobox>							 
							  <span asp-validation-for="SalesTypeId" class="text-danger"></span>		
			              </div>
	   			        </div>					 		
					 </div>	
					  	
                  
					 
					</div>
					
               </form>

                <div id="salesorderdetail">
                   @await  Html.PartialAsync("pvwSalesOrderDetail" , Model)
                </div>

                <div id="SalesOrderLineMant">
                   @await  Html.PartialAsync("pvwSalesOrderDetailMant",new ERPMVC.Models.SalesOrderLine { ProductId=0, SalesOrderLineId=0, SalesOrderId=Model.SalesOrderId  })
                </div>

               <form id="TotalesDocumento"  kendo-validator="true" kendo-messages="messages" kendo-rules="rules">
                <div class="box" id="TotalesDocumento" >
                    <div class="box-body">
                           <div class="content-container-fluid">
                        <div class="row">
                               <div class="col-lg-8">

                             </div>
                       <div class="col-lg-4">
                           <dl class="dl-horizontal">
                             <dt>						     
				              <label asp-for="Amount" class="col-md-2 control-label"></label>
                             </dt>
                               <dd>
							  <kendo-numerictextbox name="Amount"
                                  format="n2"
                                style="width: 100%;"
                                  min="0" disabled
                                  max="999999999"
                                  step="1"
                                  value="Model.Amount">
						      </kendo-numerictextbox>					
							  <span asp-validation-for="Amount" class="text-danger"></span>		
			              </dd> 			      					 
					 					
                       			
                               <dt>
				              <label asp-for="Discount" class="col-md-2 control-label" ></label>		
                               </dt>
                               <dd>
							  <kendo-numerictextbox name="Discount"
                                  format="n2"
                                  min="0"
                                  style="width: 100%;"
                                  max="999999999"
                                  step="1"
                                  disabled
                                  value="Model.Discount">
						     </kendo-numerictextbox>					
							  <span asp-validation-for="Discount" class="text-danger"></span>		
			                  </dd>
					 
                               <dt>				     
				              <label asp-for="SubTotal" class="col-md-2 control-label"></label>	
                               </dt>
                               <dd>
							  <kendo-numerictextbox name="SubTotal"
                                  format="n2"
                                  min="0"
                                required
                                disabled
                                 spinners="false"
                                    style="width: 100%;"
                                  max="999999999"
                                  step="1"
                                  value="Model.SubTotal">
						     </kendo-numerictextbox>					
							  <span asp-validation-for="SubTotal" class="text-danger"></span>		
			         				</dd>
					 					
                      	      <dt>			     
				                <label asp-for="Tax" class="col-md-2 control-label"></label>	
                               </dt>
                               <dd>
							  <kendo-numerictextbox name="Tax"
                                  format="n2"
                                  min="0"
                                  disabled
                                    style="width: 100%;"
                                  max="999999999"
                                  step="1"
                                  value="Model.Tax">
						     </kendo-numerictextbox>					
							  <span asp-validation-for="Tax" class="text-danger"></span>		
			               </dd>
                         		<dt>				     
				              <label asp-for="Freight" class="col-md-2 control-label"></label>		
                               </dt>
                               <dd>
							  <kendo-numerictextbox name="Freight"
                                  format="n2"
                                    style="width: 100%;"
                                  min="0"
                                    required
                                    onchange="CalcularTotalDocumento();"
                                  max="999999999"
                                  step="1"
                                  value="Model.Freight">
						        </kendo-numerictextbox>					
							    <span asp-validation-for="Freight" class="text-danger"></span>		
			                   </dd>
					 		
                      		  <dt>			     
				                <label asp-for="Remarks" class="col-md-2 control-label"></label>	
                               </dt>
                               <dd>
							  <textarea asp-for="Remarks" class="form-control required " style="width: 100%;"></textarea>							  						
							  <span asp-validation-for="Remarks" class="text-danger"></span>		
			            		</dd>

                                 <dt>
				              <label asp-for="TotalExento" class="col-md-2 control-label"></label>
                               </dt>
                              
                               <dd>
							  <kendo-numerictextbox name="TotalExento"
                                  format="n2"
                                  min="0" 
                                 disabled
                                 required
                                 style="width: 100%;"
                                  max="999999999"
                                  step="1"
                                  value="Model.TotalExento">
						     </kendo-numerictextbox>					
							  <span asp-validation-for="TotalExento" class="text-danger"></span>	
                             </dd>


                                     <dt>
				              <label asp-for="TotalExonerado" class="col-md-2 control-label"></label>
                               </dt>
                              
                               <dd>
							  <kendo-numerictextbox name="TotalExonerado"
                                  format="n2"
                                  min="0" 
                                 disabled
                                 required
                                 style="width: 100%;"
                                  max="999999999"
                                  step="1"
                                  value="Model.TotalExonerado">
						     </kendo-numerictextbox>					
							  <span asp-validation-for="TotalExonerado" class="text-danger"></span>	
                             </dd>

                                     <dt>
				              <label asp-for="TotalGravado" class="col-md-2 control-label"></label>
                               </dt>
                              
                               <dd>
							  <kendo-numerictextbox name="TotalGravado"
                                  format="n2"
                                  min="0" 
                                 disabled
                                 required
                                 style="width: 100%;"
                                  max="999999999"
                                  step="1"
                                  value="Model.TotalGravado">
						     </kendo-numerictextbox>					
							  <span asp-validation-for="TotalGravado" class="text-danger"></span>	
                             </dd>


                               
                               <dt>
				              <label asp-for="Total" class="col-md-2 control-label"></label>
                               </dt>
                              
                               <dd>
							  <kendo-numerictextbox name="Total"
                                  format="n2"
                                  min="0" 
                                 disabled
                                 required
                                 style="width: 100%;"
                                  max="999999999"
                                  step="1"
                                  value="Model.Total">
						     </kendo-numerictextbox>					
							  <span asp-validation-for="Total" class="text-danger"></span>	
                             </dd>
			              
					 </dl>
                       </div>
                        </div>
                 </div>
                </div>
                </div>
                   </form>

                  <div class="row">                     
                       <button id="btnSaveCotizacion" type="submit" class="form-control btn-miboton" onclick="SaveCotizacion(this);">Guardar</button>
                  </div>


			</div>	
		</div>
	</div>
</div>	

</div>
</div>
</div>
</div>


<script>
    function SaveCotizacion(e) {
     
       // e.preventDefault();
        $("#btnSaveCotizacion").hide();
        $("#btnSaveCotizacion").prop("disabled", true);

        var displayedData = $("#gridCotizacionesDetail").data().kendoGrid.dataSource.view();
       // console.log($("#CustomerId").val());
        //console.log($("#OrderDate").val());

        var dataObject = {
                    'SalesOrderId': $("#SalesOrderId").val()===""?"0":$("#SalesOrderId").val(), 
			           'SalesOrderName':$("#SalesOrderName").val(), 
			           'BranchId':$("#BranchId").val(), 
			           'CustomerId':$("#CustomerId").val(), 
			           'OrderDate':$("#OrderDate").val(), 
			           'DeliveryDate':$("#DeliveryDate").val(), 
                       'CurrencyId': $("#CurrencyId").val(),
			           'CustomerRefNumber':$("#CustomerRefNumber").val(), 
			           'SalesTypeId':$("#SalesTypeId").val(), 
			           'Remarks':$("#Remarks").val(), 
			           'Amount':$("#Amount").val(), 
			           'SubTotal':$("#SubTotal").val(), 
			           'Discount':$("#Discount").val(), 
			           'Tax':$("#Tax").val(), 
			           'Freight':$("#Freight").val(), 
			           'Total':$("#Total").val(),
                       '_SalesOrderLine': displayedData
        };

       // console.log(JSON.stringify(dataObject));
       // var form = $("#frmSalesOrder");
        //form.validate();

        var validator = $("#frmSalesOrder").data("kendoValidator");
        var validator2 = $("#TotalesDocumento").data("kendoValidator");
             var status = $(".status");

        if (displayedData.length > 0) {
            if (validator.validate() && validator2.validate()) {

                $.ajax({
                    url: '@Url.Action("SaveSalesOrder", "SalesOrder")',
                    method: 'POST',
                    datatype: "json",
                    contentType: 'application/json',
                    async: false,
                    data: JSON.stringify(dataObject),
                    success: function (data) {
                        if (data.length > 0) {
                            $("#btnSaveCotizacion").prop('disabled', false);
                            kendo.ui.progress($("#example"), false);
                            popupnotification.show("Documento generado correctamente", "success");
                            $("#myModalSalesOrder").hide();
                            return;
                        }



                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        // $("#generarfactura").prop('disabled', false);
                        kendo.ui.progress($("#example"), false);
                        $("#btngenerarfactura").show();
                        alert(textStatus + ": " + XMLHttpRequest.responseText);
                    }
                });

            }
            else {
                status.text("Oops! There is invalid data in the form.")
                    .removeClass("valid")
                    .addClass("invalid");
            }
        }
        else {
            alert('Debe agregar los productos!!');
        }

        $("#btnSaveCotizacion").show();
        $("#btnSaveCotizacion").prop("disabled", false);  
    }
</script>